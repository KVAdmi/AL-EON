import{j as e,a as N,r as n,e as w,u as S,L as T}from"./index-e4e1323c.js";import{a as A,s as k,g as E,b as F}from"./telegramService-43640fc1.js";import{R as D}from"./refresh-cw-3a330f0d.js";import{L as M}from"./loader-2-b4ab27ec.js";import{S as C}from"./send-1877c269.js";import{M as L}from"./message-square-ee262869.js";import{A as j}from"./arrow-left-1a8dd8e5.js";function R({message:t}){var d;const c=t.incoming===!0;function a(m){return new Date(m).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}return e.jsx("div",{className:`flex ${c?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] px-4 py-2.5 rounded-2xl ${c?"rounded-br-sm":"rounded-bl-sm"}`,style:{backgroundColor:c?"var(--color-accent)":"var(--color-bg-secondary)"},children:[!c&&((d=t.from)==null?void 0:d.name)&&e.jsx("p",{className:"text-xs font-medium mb-1",style:{color:"var(--color-text-secondary)"},children:t.from.name}),e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",style:{color:c?"#FFFFFF":"var(--color-text-primary)"},children:t.text}),e.jsx("div",{className:"text-xs mt-1 text-right",style:{color:c?"rgba(255, 255, 255, 0.7)":"var(--color-text-tertiary)"},children:a(t.date)})]})})}function z({chatId:t,chatName:i,botId:c,onMessageSent:a}){const{toast:d}=N(),[m,l]=n.useState([]),[o,u]=n.useState(!0),[x,f]=n.useState(!1),[y,v]=n.useState(""),s=n.useRef(null);n.useEffect(()=>{g()},[t]),n.useEffect(()=>{b()},[m]);async function g(){if(!t){console.warn("[TelegramChat] No chatId provided"),d({variant:"destructive",title:"âš ï¸ Error",description:"No hay chatId - no se pueden cargar mensajes"});return}try{u(!0),console.log("[TelegramChat] ========================================"),console.log("[TelegramChat] ðŸ” Cargando mensajes para chatId:",t),console.log("[TelegramChat] ðŸ” Bot ID:",c);const r=await A(t);console.log("[TelegramChat] ðŸ“¦ PAYLOAD COMPLETO:",JSON.stringify(r,null,2)),console.log("[TelegramChat] ðŸ“Š Tipo de dato:",typeof r,Array.isArray(r)?"ES ARRAY":"NO ES ARRAY"),console.log("[TelegramChat] ðŸ“Š Cantidad de mensajes:",(r==null?void 0:r.length)||0),Array.isArray(r)&&r.length>0?(console.log("[TelegramChat] ðŸ“¥ Mensajes incoming:",r.filter(h=>h.incoming===!0).length),console.log("[TelegramChat] ðŸ“¤ Mensajes outgoing:",r.filter(h=>h.incoming===!1).length),console.log("[TelegramChat] ðŸ“ Primer mensaje:",r[0])):console.warn("[TelegramChat] âš ï¸ Backend devolviÃ³ array vacÃ­o o formato invÃ¡lido"),console.log("[TelegramChat] ========================================"),l(Array.isArray(r)?r:[])}catch(r){console.error("[TelegramChat] âŒ Error cargando mensajes:",r),d({variant:"destructive",title:"Error cargando mensajes",description:r.message||"No se pudieron cargar los mensajes de Telegram"}),l([])}finally{u(!1)}}async function p(r){if(r.preventDefault(),!(!y.trim()||!t))try{f(!0),await k({chatId:t,text:y}),v(""),await g(),a()}catch(h){d({variant:"destructive",title:"Error",description:h.message||"No se pudo enviar el mensaje"})}finally{f(!1)}}function b(){var r;(r=s.current)==null||r.scrollIntoView({behavior:"smooth"})}return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"px-6 py-4 border-b flex items-center justify-between",style:{borderColor:"var(--color-border)"},children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center font-medium",style:{backgroundColor:"var(--color-bg-tertiary)",color:"var(--color-text-primary)"},children:i==null?void 0:i.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",style:{color:"var(--color-text-primary)"},children:i}),e.jsxs("p",{className:"text-xs",style:{color:"var(--color-text-tertiary)"},children:[m.length," mensaje(s)"]})]})]}),e.jsx("button",{onClick:g,disabled:o,className:"p-2 rounded-lg transition-all hover:opacity-80",style:{color:"var(--color-text-secondary)"},children:e.jsx(D,{size:16,className:o?"animate-spin":""})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-6 space-y-3",children:o?e.jsx("div",{className:"h-full flex items-center justify-center",style:{color:"var(--color-text-secondary)"},children:"Cargando mensajes..."}):m.length>0?e.jsxs(e.Fragment,{children:[m.map(r=>e.jsx(R,{message:r},r.id)),e.jsx("div",{ref:s})]}):e.jsx("div",{className:"h-full flex items-center justify-center",style:{color:"var(--color-text-tertiary)"},children:"No hay mensajes"})}),e.jsx("form",{onSubmit:p,className:"px-6 py-4 border-t",style:{borderColor:"var(--color-border)"},children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:y,onChange:r=>v(r.target.value),placeholder:"Escribe un mensaje...",disabled:x,className:"flex-1 px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"}}),e.jsx("button",{type:"submit",disabled:x||!y.trim(),className:"px-6 py-2.5 rounded-lg font-medium transition-all hover:opacity-90 disabled:opacity-50 flex items-center gap-2",style:{backgroundColor:"var(--color-accent)",color:"#FFFFFF"},children:x?e.jsx(M,{size:18,className:"animate-spin"}):e.jsx(C,{size:18})})]})})]})}function B({botId:t,chats:i,onChatsUpdated:c}){const[a,d]=n.useState(null);function m(l){const o=new Date(l),u=new Date,x=new Date(u);return x.setDate(x.getDate()-1),o.toDateString()===u.toDateString()?o.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}):o.toDateString()===x.toDateString()?"Ayer":o.toLocaleDateString("es-ES",{day:"numeric",month:"short"})}return e.jsxs("div",{className:"h-full flex",children:[e.jsxs("div",{className:"w-80 border-r flex flex-col",style:{borderColor:"var(--color-border)"},children:[e.jsx("div",{className:"px-4 py-3 border-b",style:{borderColor:"var(--color-border)"},children:e.jsx("h3",{className:"font-semibold",style:{color:"var(--color-text-primary)"},children:"Conversaciones"})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:i.length>0?i.map(l=>{var o;return e.jsx("button",{onClick:()=>d(l),className:`w-full px-4 py-3 border-b text-left transition-all hover:opacity-80 ${(a==null?void 0:a.id)===l.id?"font-medium":""}`,style:{backgroundColor:(a==null?void 0:a.id)===l.id?"var(--color-bg-secondary)":"transparent",borderColor:"var(--color-border)"},children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 font-medium text-sm",style:{backgroundColor:"var(--color-bg-tertiary)",color:"var(--color-text-primary)"},children:((o=l.name)==null?void 0:o.charAt(0).toUpperCase())||"U"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium truncate",style:{color:"var(--color-text-primary)"},children:l.name||l.username||"Usuario"}),l.lastMessageDate&&e.jsx("span",{className:"text-xs ml-2 flex-shrink-0",style:{color:"var(--color-text-tertiary)"},children:m(l.lastMessageDate)})]}),l.lastMessage&&e.jsx("p",{className:"text-sm truncate",style:{color:"var(--color-text-secondary)"},children:l.lastMessage})]})]})},l.id)}):e.jsxs("div",{className:"p-6 text-center",style:{color:"var(--color-text-tertiary)"},children:[e.jsx(L,{size:48,className:"mx-auto mb-3"}),e.jsx("p",{className:"text-sm font-medium mb-2",style:{color:"var(--color-text-secondary)"},children:"No hay conversaciones aÃºn"}),e.jsx("p",{className:"text-xs max-w-xs mx-auto",children:"Abre Telegram en tu telÃ©fono y envÃ­a un mensaje a tu bot para iniciar una conversaciÃ³n"})]})})]}),e.jsx("div",{className:"flex-1",children:a?e.jsx(z,{chatId:a.chatId,chatName:a.name||a.username,botId:t,onMessageSent:c}):e.jsx("div",{className:"h-full flex items-center justify-center",style:{color:"var(--color-text-tertiary)"},children:"Selecciona una conversaciÃ³n"})})]})}function q(){const{user:t}=w(),{toast:i}=N(),c=S(),[a,d]=n.useState([]),[m,l]=n.useState([]),[o,u]=n.useState(null),[x,f]=n.useState(!0);n.useEffect(()=>{y()},[t]),n.useEffect(()=>{o&&v()},[o]);async function y(){if(t)try{f(!0);const s=await E(t.id),g=Array.isArray(s)?s:[];d(g);const p=g.find(b=>b.isConnected);p&&u(p)}catch(s){console.error("Error cargando bots:",s),d([]),i({variant:"destructive",title:"Error",description:s.message||"No se pudieron cargar los bots"})}finally{f(!1)}}async function v(){if(!(!t||!o))try{const s=await F(t.id,o.id);l(s||[])}catch(s){console.error("Error cargando chats:",s),i({variant:"destructive",title:"Error",description:s.message||"No se pudieron cargar los chats"})}}return x?e.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"var(--color-bg-primary)"},children:e.jsx("div",{style:{color:"var(--color-text-secondary)"},children:"Cargando..."})}):!Array.isArray(a)||a.length===0||!a.some(s=>s.isConnected)?e.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",style:{backgroundColor:"var(--color-bg-primary)"},children:e.jsxs("div",{className:"max-w-md text-center p-8 rounded-xl border",style:{backgroundColor:"var(--color-bg-secondary)",borderColor:"var(--color-border)"},children:[e.jsx(C,{size:64,className:"mx-auto mb-4",style:{color:"var(--color-text-tertiary)"}}),e.jsx("h2",{className:"text-2xl font-bold mb-3",style:{color:"var(--color-text-primary)"},children:"No hay bots conectados"}),e.jsx("p",{className:"mb-6",style:{color:"var(--color-text-secondary)"},children:"Conecta un bot de Telegram para comenzar a recibir y enviar mensajes"}),e.jsx(T,{to:"/settings/telegram",className:"inline-block py-3 px-6 rounded-xl font-medium transition-all hover:opacity-90",style:{backgroundColor:"var(--color-accent)",color:"#FFFFFF"},children:"Configurar Telegram"})]})}):e.jsxs("div",{className:"h-screen flex",style:{backgroundColor:"var(--color-bg-primary)"},children:[a.length>1&&e.jsxs("div",{className:"w-64 border-r flex flex-col",style:{borderColor:"var(--color-border)"},children:[e.jsx("div",{className:"p-4 border-b",style:{borderColor:"var(--color-border)"},children:e.jsxs("button",{onClick:()=>c(-1),className:"w-full px-4 py-2 rounded-lg transition-all hover:opacity-80 flex items-center gap-2",style:{backgroundColor:"var(--color-bg-secondary)",color:"var(--color-text-primary)",border:"1px solid var(--color-border)"},children:[e.jsx(j,{size:18}),e.jsx("span",{className:"font-medium",children:"Volver"})]})}),e.jsxs("div",{className:"p-4 flex-1",children:[e.jsx("h3",{className:"font-semibold mb-3",style:{color:"var(--color-text-primary)"},children:"Bots conectados"}),e.jsx("div",{className:"space-y-2",children:Array.isArray(a)&&a.filter(s=>s.isConnected).map(s=>e.jsxs("button",{onClick:()=>u(s),className:`w-full px-4 py-3 rounded-lg text-left transition-all ${(o==null?void 0:o.id)===s.id?"font-medium":""}`,style:{backgroundColor:(o==null?void 0:o.id)===s.id?"var(--color-bg-secondary)":"transparent",color:"var(--color-text-primary)"},children:["@",s.botUsername]},s.id))})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[a.length===1&&e.jsx("div",{className:"p-4 border-b",style:{borderColor:"var(--color-border)"},children:e.jsxs("button",{onClick:()=>c(-1),className:"px-4 py-2 rounded-lg transition-all hover:opacity-80 flex items-center gap-2",style:{backgroundColor:"var(--color-bg-secondary)",color:"var(--color-text-primary)",border:"1px solid var(--color-border)"},children:[e.jsx(j,{size:18}),e.jsx("span",{className:"font-medium",children:"Volver"})]})}),e.jsx("div",{className:"flex-1",children:o?e.jsx(B,{botId:o.id,chats:m,onChatsUpdated:v}):e.jsx("div",{className:"h-full flex items-center justify-center",style:{color:"var(--color-text-tertiary)"},children:"Selecciona un bot"})})]})]})}export{q as default};
