import{s as w}from"./index-e4e1323c.js";import{g as k,l as A,a as F}from"./requestId-b38e007e.js";const d="https://api.al-eon.com";async function u(){try{const{data:{session:e},error:r}=await w.auth.getSession();return r?(console.warn("[EmailService] ‚ö†Ô∏è Error obteniendo sesi√≥n:",r.message),null):e!=null&&e.access_token?e.access_token:(console.warn("[EmailService] ‚ö†Ô∏è No hay sesi√≥n activa"),null)}catch(e){return console.error("[EmailService] ‚ùå Error en getAuthToken:",e),null}}async function b(e,r={},o={}){const t=k(),a=e.replace(d,"");console.log(`[REQ] üì§ ${r.method||"GET"} ${a} - id=${t}`);try{const s={...r.headers,"x-request-id":t},c=await fetch(e,{...r,headers:s}),n=await c.json().catch(()=>null);return c.ok?F(t,a,c.status,o):A(t,a,{status:c.status,message:(n==null?void 0:n.message)||c.statusText,...o}),c.data=n,c}catch(s){throw A(t,a,{error:s.message,...o}),s}}function N(e){if(!e)return"INBOX";const r=String(e).toLowerCase().trim(),t={inbox:"INBOX",sent:"SENT",drafts:"DRAFT",draft:"DRAFT",spam:"SPAM",junk:"SPAM",trash:"TRASH",deleted:"TRASH","bandeja de entrada":"INBOX",enviados:"SENT",borradores:"DRAFT",papelera:"TRASH","no deseado":"SPAM","[gmail]/sent mail":"SENT","[gmail]/drafts":"DRAFT","[gmail]/spam":"SPAM","[gmail]/trash":"TRASH","sent items":"SENT","deleted items":"TRASH","junk email":"SPAM"}[r];return t?(console.log(`[EmailService] üîÑ Normalizado "${e}" ‚Üí "${t}"`),t):r.includes("inbox")||r.includes("entrada")?"INBOX":r.includes("sent")||r.includes("enviados")?"SENT":r.includes("draft")||r.includes("borrador")?"DRAFT":r.includes("spam")||r.includes("junk")?"SPAM":r.includes("trash")||r.includes("papelera")||r.includes("deleted")?"TRASH":(console.warn(`[EmailService] ‚ö†Ô∏è Folder "${e}" no reconocido, asumiendo INBOX`),"INBOX")}async function x(e,r){try{console.log("[EmailService] üîç Obteniendo cuentas para userId:",e);const{data:o,error:t}=await w.from("email_accounts").select("*").eq("owner_user_id",e).order("created_at",{ascending:!1});return t?(console.error("[EmailService] ‚ùå Error de Supabase:",t),[]):(console.log("[EmailService] ‚úÖ Cuentas encontradas:",(o==null?void 0:o.length)||0),console.log("[EmailService] üìã Detalle de cuentas:",o==null?void 0:o.map(a=>({id:a.id,email:a.from_email,provider:a.provider,is_active:a.is_active}))),o||[])}catch(o){return console.error("[EmailService] ‚ùå Error en getEmailAccounts:",o),[]}}async function z(e,r,o){try{const a={"Content-Type":"application/json",Authorization:`Bearer ${o||await u()}`},s=await fetch(`${d}/api/mail/folders/${e}?ownerUserId=${r}`,{method:"GET",headers:a,credentials:"include"});if(!s.ok){const n=await s.json();throw new Error(n.message||"Error al obtener carpetas")}return(await s.json()).folders||[]}catch(t){throw console.error("[EmailService] Error en getFolders:",t),t}}async function M(e,r=null){try{const o=await u(),t=r?`${d}/api/mail/drafts?ownerUserId=${e}&accountId=${r}`:`${d}/api/mail/drafts?ownerUserId=${e}`,a=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include"});if(!a.ok){const c=await a.json();throw new Error(c.message||"Error al obtener borradores")}return(await a.json()).drafts||[]}catch(o){throw console.error("[EmailService] Error en getDrafts:",o),o}}async function P(e){try{const r=await u(),o=await fetch(`${d}/api/mail/drafts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},credentials:"include",body:JSON.stringify(e)});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al crear borrador")}return await o.json()}catch(r){throw console.error("[EmailService] Error en createDraft:",r),r}}async function R(e,r){try{const o=await u(),t=await fetch(`${d}/api/mail/drafts/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify(r)});if(!t.ok){const a=await t.json();throw new Error(a.message||"Error al actualizar borrador")}return await t.json()}catch(o){throw console.error("[EmailService] Error en updateDraft:",o),o}}async function L(e){try{const r=await u(),o=await fetch(`${d}/api/mail/drafts/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`},credentials:"include"});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al eliminar borrador")}return await o.json()}catch(r){throw console.error("[EmailService] Error en deleteDraft:",r),r}}async function q(e){try{const r=await u(),o=await fetch(`${d}/api/mail/drafts/${e}/send`,{method:"POST",headers:{Authorization:`Bearer ${r}`},credentials:"include"});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al enviar borrador")}return await o.json()}catch(r){throw console.error("[EmailService] Error en sendDraft:",r),r}}async function D(e,r,o=null,t=null){try{const a=await u(),s=new FormData;s.append("file",e),s.append("ownerUserId",r),o&&s.append("draftId",o),t&&s.append("messageId",t);const c=await fetch(`${d}/api/mail/attachments/upload`,{method:"POST",headers:{Authorization:`Bearer ${a}`},credentials:"include",body:s});if(!c.ok){const n=await c.json();throw new Error(n.message||"Error al subir archivo")}return await c.json()}catch(a){throw console.error("[EmailService] Error en uploadAttachment:",a),a}}function H(e){return`${d}/api/mail/attachments/${e}/download`}async function U(e){try{const r=await u(),o=await fetch(`${d}/api/mail/attachments/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${r}`},credentials:"include"});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al eliminar adjunto")}return await o.json()}catch(r){throw console.error("[EmailService] Error en deleteAttachment:",r),r}}async function J(e){try{const r=await u(),o=await fetch(`${d}/api/email/accounts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},credentials:"include",body:JSON.stringify(e)});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al crear cuenta de email")}return await o.json()}catch(r){throw console.error("[EmailService] Error en createEmailAccount:",r),r}}async function V(e,r){try{const o=await u(),t=await fetch(`${d}/api/email/accounts/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify(r)});if(!t.ok){const a=await t.json();throw new Error(a.message||"Error al actualizar cuenta de email")}return await t.json()}catch(o){throw console.error("[EmailService] Error en updateEmailAccount:",o),o}}async function G(e){try{const r=await u(),o=await fetch(`${d}/api/email/accounts/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},credentials:"include"});if(!o.ok){const t=await o.json();throw new Error(t.message||"Error al eliminar cuenta de email")}return await o.json()}catch(r){throw console.error("[EmailService] Error en deleteEmailAccount:",r),r}}async function X(e){try{const r=await u(),o=await fetch(`${d}/api/email/accounts/${e}/test`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},credentials:"include"}),t=o.headers.get("content-type");if(!t||!t.includes("application/json"))return console.error("[EmailService] ‚ö†Ô∏è Endpoint no implementado - respuesta HTML"),{success:!1,message:"‚ö†Ô∏è El backend a√∫n no tiene implementado el test de conexi√≥n IMAP. Guarda la cuenta y verifica manualmente."};const a=await o.json();return o.ok?{success:!0,message:a.message||"Conexi√≥n exitosa"}:{success:!1,message:a.message||a.error||"Error al probar conexi√≥n"}}catch(r){return console.error("[EmailService] Error en testEmailConnection:",r),r.message.includes("JSON")||r.message.includes("Unexpected token")?{success:!1,message:"‚ö†Ô∏è El backend a√∫n no tiene implementado este endpoint. Puedes guardar la cuenta de todas formas."}:{success:!1,message:r.message||"Error de red al probar conexi√≥n"}}}async function K(e,r=null){var o;try{console.log("[EmailService] üì§ Enviando email...",e);let t=r,a=null;if(t){console.log("[EmailService] ‚úÖ Token recibido como par√°metro");try{a=JSON.parse(atob(t.split(".")[1])).sub,console.log("[EmailService] üîç User ID del token:",a)}catch{console.error("[EmailService] ‚ö†Ô∏è No se pudo extraer userId del token")}}else{console.log("[EmailService] üîç No se pas√≥ token, obteniendo de sesi√≥n...");const{data:l,error:p}=await w.auth.getSession();if(p)throw console.error("[EmailService] ‚ùå Error obteniendo sesi√≥n:",p),new Error("Error de autenticaci√≥n. Intenta cerrar sesi√≥n y volver a iniciar.");const E=l==null?void 0:l.session;t=E==null?void 0:E.access_token,a=(o=E==null?void 0:E.user)==null?void 0:o.id,console.log("[EmailService] üîç Session existe:",!!E),console.log("[EmailService] üîç Token obtenido:",t?t.substring(0,20)+"...":"NO"),console.log("[EmailService] üîç User ID:",a)}if(!t)throw console.error("[EmailService] ‚ùå NO HAY TOKEN DE AUTENTICACI√ìN"),new Error("No est√°s autenticado. Por favor cierra sesi√≥n y vuelve a iniciar.");console.log("[EmailService] ‚úÖ Token disponible, preparando env√≠o...");const s=Array.isArray(e.to)?e.to:String(e.to||""),c=Array.isArray(s)?s.map(l=>String(l||"").trim()).filter(Boolean):s.split(",").map(l=>l.trim()).filter(Boolean),n=String(e.subject||"").trim(),i=String(e.body||"").trim();if(!e.accountId)throw new Error("Selecciona una cuenta de correo antes de enviar.");if(!c.length)throw new Error("Falta el destinatario (to).");if(!n)throw new Error("Falta el asunto (subject).");if(!i)throw new Error("Falta el contenido del correo (body/html).");const h={accountId:e.accountId,to:c,subject:n,body:i};if(e.cc){const l=Array.isArray(e.cc)?e.cc.map(p=>String(p||"").trim()).filter(Boolean):String(e.cc).split(",").map(p=>p.trim()).filter(Boolean);l.length&&(h.cc=l)}if(e.bcc){const l=Array.isArray(e.bcc)?e.bcc.map(p=>String(p||"").trim()).filter(Boolean):String(e.bcc).split(",").map(p=>p.trim()).filter(Boolean);l.length&&(h.bcc=l)}e.attachments&&(h.attachments=e.attachments),console.log("[EmailService] üì¶ Payload transformado:",h);const m=await b(`${d}/api/mail/send`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include",body:JSON.stringify(h)},{userId:a,accountId:e.accountId,to:c.join(",")}),f=m.data;if(!m.ok)throw console.error("[EmailService] ‚ùå Error del servidor:",m.status,f),new Error((f==null?void 0:f.message)||"Error al enviar email");return console.log("[EmailService] ‚úÖ Email enviado:",f),f}catch(t){throw console.error("[EmailService] Error en sendEmail:",t),t}}async function Q(e,r={}){try{console.log("[EmailService] üì¨ getInbox llamado con:",{accountId:e,options:r});const o=N(r.folder);console.log(`[EmailService] üè∑Ô∏è Label est√°ndar: ${o}`);let t=null;if(r.folder){const n=String(r.folder).toLowerCase().trim(),h={inbox:"Inbox",sent:"Sent",drafts:"Drafts",spam:"Spam",trash:"Trash",starred:"Starred",archive:"Archive",junk:"Spam","bandeja de entrada":"Inbox",enviados:"Sent",borradores:"Drafts",papelera:"Trash",destacados:"Starred",archivados:"Archive","[gmail]/sent mail":"Sent","[gmail]/drafts":"Drafts","[gmail]/spam":"Spam","[gmail]/trash":"Trash","[gmail]/starred":"Starred"}[n]||r.folder;console.log(`[EmailService] üîç Buscando folder: "${r.folder}" ‚Üí tipo "${h}"`);let{data:m,error:f}=await w.from("email_folders").select("id, folder_name, folder_type").eq("account_id",e).eq("folder_type",h).maybeSingle();if(!m&&!f){console.log("[EmailService] ‚ö†Ô∏è No encontrado por folder_type, intentando por folder_name...");const l=await w.from("email_folders").select("id, folder_name, folder_type").eq("account_id",e).eq("folder_name",r.folder).maybeSingle();m=l.data,f=l.error}f?console.warn("[EmailService] ‚ö†Ô∏è Error buscando folder:",f):m!=null&&m.id?(t=m.id,console.log("[EmailService] ‚úÖ Folder encontrado:",m)):console.warn(`[EmailService] ‚ö†Ô∏è No se encontr√≥ folder para: "${r.folder}"`)}let a=w.from("email_messages").select(`
        *,
        folder:email_folders!folder_id(id, folder_name, folder_type, imap_path)
      `).eq("account_id",e);t?(a=a.eq("folder_id",t),console.log(`[EmailService] üîç FILTRANDO por folder_id: ${t}`)):r.folder&&console.error(`[EmailService] ‚ùå FILTRO NO APLICADO - No se encontr√≥ folder_id para "${r.folder}"`),a=a.order("date",{ascending:!1}).limit(r.limit||50);const{data:s,error:c}=await a;if(c)throw console.error("[EmailService] Error de Supabase:",c),new Error("Error al obtener mensajes de Supabase");return console.log(`[EmailService] ‚úÖ ${(s==null?void 0:s.length)||0} mensajes obtenidos de Supabase`),{label:o,count:(s==null?void 0:s.length)||0,messages:(s||[]).map(n=>{var i,h,m;return{id:n.id,message_id:n.id,from_address:n.from_address,from_name:n.from_name,from_email:n.from_address,to_addresses:n.to_addresses,subject:n.subject,preview:n.body_preview,body_preview:n.body_preview,date:n.date,received_at:n.date,is_read:n.is_read,is_starred:n.is_starred,has_attachments:n.has_attachments,account_id:n.account_id,folder:((i=n.folder)==null?void 0:i.folder_name)||((h=n.folder)==null?void 0:h.folder_type)||"Unknown",folder_id:n.folder_id,folder_type:(m=n.folder)==null?void 0:m.folder_type,label:o}})}}catch(o){throw console.error("[EmailService] Error en getInbox:",o),o}}async function W(e,r){var o,t;try{console.log("[EmailService] üìß getMessage - Leyendo DIRECTO de Supabase:",{accountId:e,messageId:r});const{data:a,error:s}=await w.from("email_messages").select("*").eq("id",r).eq("account_id",e).single();if(s)throw console.error("[EmailService] ‚ùå Error Supabase:",s),new Error("Error al obtener mensaje de base de datos");if(!a)throw new Error("Mensaje no encontrado");return console.log("[EmailService] ‚úÖ Mensaje obtenido de Supabase:",{id:a.id,has_body_html:!!a.body_html,has_body_text:!!a.body_text,body_html_length:((o=a.body_html)==null?void 0:o.length)||0,body_text_length:((t=a.body_text)==null?void 0:t.length)||0,subject:a.subject}),{id:a.id,from:a.from_address||a.from_name||"Desconocido",from_address:a.from_address,from_name:a.from_name,to_addresses:a.to_addresses||[],cc_addresses:a.cc_addresses||[],bcc_addresses:a.bcc_addresses||[],subject:a.subject||"(Sin asunto)",body_text:a.body_text||"",body_html:a.body_html||"",body_preview:a.body_preview||"",date:a.date||a.created_at,sent_at:a.date,is_read:a.is_read||!1,is_starred:a.is_starred||!1,has_attachments:a.has_attachments||!1,attachment_count:a.attachment_count||0,account_id:a.account_id,folder:a.folder}}catch(a){throw console.error("[EmailService] ‚ùå Error en getMessage:",a),a}}async function Y(e,r){try{const o=await u(),t=await fetch(`${d}/api/mail/messages/${r}/star`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify({accountId:e})});if(!t.ok){const a=await t.json();throw new Error(a.message||"Error al actualizar estrella")}return await t.json()}catch(o){throw console.error("[EmailService] Error en toggleStar:",o),o}}async function Z(e,r,o){var t;try{const a=await u(),s=await b(`${d}/api/mail/messages/${r}/move`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},credentials:"include",body:JSON.stringify({accountId:e,folder:o})},{accountId:e,messageId:r,folderName:o});if(!s.ok)throw new Error(((t=s.data)==null?void 0:t.message)||"Error al mover mensaje");return s.data}catch(a){throw console.error("[EmailService] Error en moveToFolder:",a),a}}async function ee(e){var r;try{console.log("[EmailService] üîÑ Iniciando sincronizaci√≥n para cuenta:",e);const o=await u(),t=await b(`${d}/api/email/accounts/${e}/sync`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include"},{accountId:e});if(!t.ok){const a=t.data||{message:"Error desconocido"};throw console.error("[EmailService] ‚ùå Error del servidor:",{status:t.status,statusText:t.statusText,error:a}),t.status===500&&((r=a.message)!=null&&r.includes("Invalid credentials"))?new Error("‚ùå Credenciales IMAP inv√°lidas. Por favor verifica tu usuario y contrase√±a en la configuraci√≥n de la cuenta."):t.status===500?new Error("‚ùå Error del servidor al sincronizar. El backend puede estar desconectado o las credenciales son incorrectas."):new Error(a.message||"Error al sincronizar cuenta")}return console.log("[EmailService] ‚úÖ Sincronizaci√≥n exitosa:",t.data),t.data}catch(o){throw console.error("[EmailService] ‚ùå Error en syncEmailAccount:",o),o}}async function re(e,r){try{const o=await u(),t=await fetch(`${d}/api/mail/drafts`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify({accountId:e,...r})});if(!t.ok){const a=await t.json();throw new Error(a.message||"Error al guardar borrador")}return await t.json()}catch(o){throw console.error("[EmailService] Error en saveDraft:",o),o}}async function oe(e){try{const{data:r,error:o}=await w.from("contacts").select("*").eq("owner_user_id",e).order("name",{ascending:!0});if(o)throw o;return r||[]}catch(r){throw console.error("[EmailService] Error obteniendo contactos:",r),r}}async function C(e,r){try{const{data:o,error:t}=await w.from("contacts").insert([{owner_user_id:e,name:r.name,email:r.email,phone:r.phone||null,company:r.company||null,notes:r.notes||null}]).select().single();if(t)throw t;return o}catch(o){throw console.error("[EmailService] Error creando contacto:",o),o}}async function ae(e,r){try{const o=await e.text(),t=I(o);console.log(`üìá Importando ${t.length} contactos desde vCard...`);const a={success:0,errors:0,imported:[]};for(const s of t)try{const c=await C(r,s);a.success++,a.imported.push(c)}catch(c){console.error("Error importando contacto:",s,c),a.errors++}return console.log(`‚úÖ Importaci√≥n completada: ${a.success} √©xitos, ${a.errors} errores`),a}catch(o){throw console.error("[EmailService] Error importando vCard:",o),o}}function I(e){var t,a,s;const r=[];e=e.replace(/\r\n/g,`
`).replace(/\r/g,`
`);const o=e.split(/BEGIN:VCARD/i);console.log(`üìá Encontrados ${o.length-1} posibles vCards en el archivo`);for(let c=1;c<o.length;c++)try{const n="BEGIN:VCARD"+o[c],i={name:"",email:"",phone:"",company:"",notes:""};let h=n.match(/\nFN[^:]*:([^\n]+)/i);if(h)i.name=g(h[1]);else{let y=n.match(/\nN[^:]*:([^\n]+)/i);if(y){const S=y[1].split(";"),$=S[0]||"",T=S[1]||"",j=S[2]||"";i.name=`${T} ${j} ${$}`.trim(),i.name=g(i.name)}}let m=n.match(/\nEMAIL[^:]*:([^\n]+)/i);m&&(i.email=g(m[1]).toLowerCase(),i.email=i.email.replace(/[<>\"']/g,"").trim());let f=n.match(/\n(?:item\d+\.)?TEL[^:]*:([^\n]+)/i);f&&(i.phone=g(f[1]).trim());let l=n.match(/\nORG[^:]*:([^\n]+)/i);l&&(i.company=g(l[1]));let p=n.match(/\nNOTE[^:]*:([^\n]+)/i);if(p)i.notes=g(p[1]);else{let y=n.match(/\nCATEGORIES[^:]*:([^\n]+)/i);y&&(i.notes=g(y[1]))}const E=i.name&&i.name.length>=1,_=i.email&&i.email.includes("@")&&i.email.length>=5&&!i.email.includes(" "),v=i.phone&&i.phone.length>=7;E&&(_||v)?(!i.email&&i.phone&&(i.email=`tel_${i.phone.replace(/[^0-9]/g,"")}@phone.local`),r.push(i)):console.warn(`‚ö†Ô∏è vCard ${c} ignorado:`,{name:(t=i.name)==null?void 0:t.substring(0,30),email:(a=i.email)==null?void 0:a.substring(0,40),phone:(s=i.phone)==null?void 0:s.substring(0,20),hasValidName:E,hasValidEmail:_,hasValidPhone:v})}catch(n){console.error(`‚ùå Error en vCard ${c}:`,n.message)}return console.log(`‚úÖ ${r.length} de ${o.length-1} contactos v√°lidos encontrados`),r}function g(e){if(!e)return"";if(e.includes("="))try{e=e.replace(/=([0-9A-F]{2})/gi,(r,o)=>String.fromCharCode(parseInt(o,16))),e=e.replace(/=$/g,"")}catch{}return e=e.replace(/[\u{1F300}-\u{1F9FF}]/gu,""),e=e.replace(/[\u{1F600}-\u{1F64F}]/gu,""),e=e.replace(/[\u{1F680}-\u{1F6FF}]/gu,""),e=e.replace(/[\u{2600}-\u{26FF}]/gu,""),e=e.replace(/[\u{2700}-\u{27BF}]/gu,""),e=e.replace(/[\u{FE00}-\u{FE0F}]/gu,""),e=e.replace(/[\u{1F900}-\u{1F9FF}]/gu,""),e=e.replace(/[\u{1FA70}-\u{1FAFF}]/gu,""),e=e.replace(/[‚öõÔ∏è‚ôâÔ∏èüèª‚òòÔ∏è]/g,""),e=e.replace(/[\u{FE00}-\u{FE0F}\u{E0100}-\u{E01EF}]/gu,""),e=e.replace(/\?+/g,""),e=e.replace(/[\x00-\x1F\x7F]/g,""),e=e.replace(/\s+/g," "),e.trim()}export{z as a,Q as b,C as c,G as d,W as e,oe as f,x as g,J as h,ae as i,L as j,H as k,R as l,P as m,D as n,U as o,q as p,M as q,Y as r,ee as s,X as t,V as u,Z as v,K as w,re as x};
