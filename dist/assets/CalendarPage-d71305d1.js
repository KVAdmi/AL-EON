import{c as M,j as e,r as w,a as F,R as P,X as _,e as U,u as H}from"./index-e4e1323c.js";import{C as O}from"./clock-8cb9f32e.js";import{U as $}from"./users-d80d56b5.js";import{C as W}from"./chevron-left-64bd04f0.js";import{C as q}from"./chevron-right-8a01d50b.js";import{C as R}from"./calendar-e8089789.js";import{B as D}from"./bell-a4a3aff2.js";import{L as T}from"./loader-2-b4ab27ec.js";import{P as B}from"./pen-line-7665e45d.js";import{T as V}from"./trash-2-720af3a0.js";import{A as J}from"./arrow-left-1a8dd8e5.js";import{P as G}from"./plus-b374ad1c.js";const z=M("MapPin",[["path",{d:"M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z",key:"2oe9fu"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]),E="https://api.al-eon.com";function K(r){const o=r.start_at||r.from,l=r.end_at||r.to;return{...r,id:r.id,title:r.title,description:r.description,location:r.location,from:o,to:l,startTime:o,endTime:l,start_at:o,end_at:l,start:o?new Date(o):null,end:l?new Date(l):null}}async function Q(r,o={}){var l;try{const i=new URLSearchParams({ownerUserId:r,...o.startDate&&{startDate:o.startDate.toISOString()},...o.endDate&&{endDate:o.endDate.toISOString()}}),d={"Content-Type":"application/json"};o.accessToken&&(d.Authorization=`Bearer ${o.accessToken}`);const u=await fetch(`${E}/api/calendar/events?${i}`,{method:"GET",headers:d,credentials:"include"});if(!u.ok){const h=await u.json();throw new Error(h.message||"Error al obtener eventos")}const y=await u.json();console.log("üì• [CalendarService] Respuesta GET eventos:",{success:y.success,count:((l=y.events)==null?void 0:l.length)||0,hasEvents:!!y.events});const x=y.events||y||[];return Array.isArray(x)?x.map(K):[]}catch(i){throw console.error("[CalendarService] Error en getEvents:",i),i}}async function Y(r,o){var y,x;const l={title:r.title,start_at:r.from,end_at:r.to,timezone:"America/Mexico_City",ownerUserId:r.userId||r.ownerUserId,reason:r.description||r.title,description:r.description,location:r.location,attendees:r.attendees,notification_minutes:r.reminder?parseInt(r.reminder):null};console.log("üöÄ [CalendarService] Payload ANTES de enviar:",JSON.stringify(l,null,2)),console.log("üîë [CalendarService] Token presente:",!!o,"Length:",o==null?void 0:o.length);const i=await fetch(`${E}/api/calendar/events`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify(l)});if(!i.ok){const h=await i.text().catch(()=>"");throw console.error("‚ùå [CalendarService] Error HTTP:",i.status,h),new Error(h||`HTTP ${i.status}`)}const d=await i.json().catch(()=>({}));console.log("üì• [CalendarService] Respuesta del backend:",{status:i.status,ok:i.ok,data:d});const u=((y=d.event)==null?void 0:y.id)||((x=d.evidence)==null?void 0:x.id)||d.id;return u?{success:d.success||!0,eventId:u,message:d.userMessage||"Evento creado",event:d.event,data:d}:(console.warn("‚ö†Ô∏è Evento creado pero respuesta sin id",d),{success:d.success||!0,eventId:null,message:d.userMessage||"Evento creado",data:d})}async function Z(r,o,l){try{const i={"Content-Type":"application/json"};l&&(i.Authorization=`Bearer ${l}`);const d=await fetch(`${E}/api/calendar/events/${r}`,{method:"PATCH",headers:i,credentials:"include",body:JSON.stringify(o)});if(!d.ok){const u=await d.json();throw new Error(u.message||"Error al actualizar evento")}return await d.json()}catch(i){throw console.error("[CalendarService] Error en updateEvent:",i),i}}async function X(r,o){try{const l={"Content-Type":"application/json"};o&&(l.Authorization=`Bearer ${o}`);const i=await fetch(`${E}/api/calendar/events/${r}`,{method:"DELETE",headers:l,credentials:"include"});if(!i.ok){const d=await i.json();throw new Error(d.message||"Error al eliminar evento")}return await i.json()}catch(l){throw console.error("[CalendarService] Error en deleteEvent:",l),l}}async function ee(r,o){const l=new Date,i=new Date(l);i.setDate(l.getDate()-l.getDay()),i.setHours(0,0,0,0);const d=new Date(i);return d.setDate(i.getDate()+7),Q(r,{startDate:i,endDate:d,accessToken:o})}function L({event:r,compact:o=!1,onClick:l}){const i=r.from||r.startTime,d=r.to||r.endTime;function u(h){return new Date(h).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})}function y(h,g){const a=new Date(h),N=new Date(g),m=Math.floor((N-a)/(1e3*60));if(m<60)return`${m} min`;{const b=Math.floor(m/60),s=m%60;return s>0?`${b}h ${s}min`:`${b}h`}}const x="var(--color-accent)";return o?e.jsxs("button",{onClick:l,className:"w-full p-2.5 rounded-lg text-left transition-all hover:shadow-sm border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",borderLeftWidth:"3px",borderLeftColor:x},children:[e.jsx("div",{className:"text-xs font-medium mb-1",style:{color:"var(--color-text-tertiary)"},children:u(i)}),e.jsx("div",{className:"text-sm font-semibold line-clamp-2",style:{color:"var(--color-text-primary)"},children:r.title})]}):e.jsxs("button",{onClick:l,className:"w-full p-4 rounded-xl text-left transition-all hover:shadow-md border",style:{backgroundColor:"var(--color-bg-secondary)",borderColor:"var(--color-border)",borderLeftWidth:"4px",borderLeftColor:x},children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h4",{className:"font-semibold text-lg",style:{color:"var(--color-text-primary)"},children:r.title}),e.jsx("span",{className:"px-2.5 py-1 text-xs rounded-full font-medium whitespace-nowrap ml-2",style:{backgroundColor:`${x}20`,color:x},children:y(i,d)})]}),e.jsxs("div",{className:"space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",style:{color:"var(--color-text-secondary)"},children:[e.jsx(O,{size:14}),e.jsxs("span",{children:[u(i)," - ",u(d)]})]}),r.location&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",style:{color:"var(--color-text-secondary)"},children:[e.jsx(z,{size:14}),e.jsx("span",{className:"line-clamp-1",children:r.location})]}),r.attendees&&r.attendees.length>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",style:{color:"var(--color-text-secondary)"},children:[e.jsx($,{size:14}),e.jsxs("span",{children:[r.attendees.length," asistente(s)"]})]})]}),r.description&&e.jsx("p",{className:"mt-3 text-sm line-clamp-2",style:{color:"var(--color-text-tertiary)"},children:r.description})]})}function re({events:r,selectedDate:o,onDateChange:l,onEventClick:i,onEventUpdated:d}){const[u,y]=w.useState("week");function x(n){const p=new Date(n);p.setDate(n.getDate()-n.getDay()),p.setHours(0,0,0,0);const v=[];for(let t=0;t<7;t++){const c=new Date(p);c.setDate(p.getDate()+t),v.push(c)}return v}const h=x(o),g=new Date;g.setHours(0,0,0,0);function a(n){const p=new Date(n);p.setHours(0,0,0,0);const v=new Date(n);if(v.setHours(23,59,59,999),!Array.isArray(r))return console.warn("[CalendarView] events no es un array:",r),[];console.log("[CalendarView] Filtrando eventos para d√≠a:",n.toDateString(),{totalEvents:r.length,dayStart:p.toISOString(),dayEnd:v.toISOString()});const t=r.filter(c=>{const j=new Date(c.from||c.start_at||c.startTime||c.start),f=j>=p&&j<=v;return f||console.log("[CalendarView] Evento fuera de rango:",{title:c.title,eventStart:j.toISOString(),dayStart:p.toISOString(),dayEnd:v.toISOString()}),f}).sort((c,j)=>{const f=new Date(c.from||c.start_at||c.startTime||c.start),C=new Date(j.from||j.start_at||j.startTime||j.start);return f-C});return console.log("[CalendarView] Eventos filtrados para",n.toDateString(),":",t.length),t}function N(){const n=new Date(o);n.setDate(n.getDate()-7),l(n)}function m(){const n=new Date(o);n.setDate(n.getDate()+7),l(n)}function b(){l(new Date)}function s(){const n=h[0],p=h[6];return n.getMonth()===p.getMonth()?`${n.toLocaleDateString("es-ES",{month:"long",year:"numeric"})}`:`${n.toLocaleDateString("es-ES",{month:"short"})} - ${p.toLocaleDateString("es-ES",{month:"short",year:"numeric"})}`}return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-0 mb-4 sm:mb-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-3 w-full sm:w-auto",children:[e.jsx("button",{onClick:b,className:"px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg font-medium border transition-all hover:opacity-80 text-sm",style:{borderColor:"var(--color-border)",color:"var(--color-text-primary)"},children:"Hoy"}),e.jsxs("div",{className:"flex items-center gap-1 sm:gap-2",children:[e.jsx("button",{onClick:N,className:"p-1.5 sm:p-2 rounded-lg transition-all hover:opacity-80",style:{backgroundColor:"var(--color-bg-secondary)",color:"var(--color-text-primary)"},children:e.jsx(W,{className:"w-4 h-4 sm:w-5 sm:h-5"})}),e.jsx("button",{onClick:m,className:"p-1.5 sm:p-2 rounded-lg transition-all hover:opacity-80",style:{backgroundColor:"var(--color-bg-secondary)",color:"var(--color-text-primary)"},children:e.jsx(q,{className:"w-4 h-4 sm:w-5 sm:h-5"})})]}),e.jsx("h3",{className:"text-sm sm:text-lg font-semibold capitalize",style:{color:"var(--color-text-primary)"},children:s()})]}),e.jsxs("div",{className:"flex rounded-lg border overflow-hidden w-full sm:w-auto",style:{borderColor:"var(--color-border)"},children:[e.jsx("button",{onClick:()=>y("week"),className:`flex-1 sm:flex-none px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium transition-all ${u==="week"?"font-semibold":""}`,style:{backgroundColor:u==="week"?"var(--color-bg-secondary)":"transparent",color:"var(--color-text-primary)"},children:"Semana"}),e.jsx("button",{onClick:()=>y("list"),className:`flex-1 sm:flex-none px-3 sm:px-4 py-1.5 sm:py-2 text-xs sm:text-sm font-medium transition-all border-l ${u==="list"?"font-semibold":""}`,style:{backgroundColor:u==="list"?"var(--color-bg-secondary)":"transparent",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},children:"Lista"})]})]}),u==="week"&&e.jsx("div",{className:"flex-1 grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-1 sm:gap-2 overflow-auto",children:h.map((n,p)=>{const v=n.getTime()===g.getTime(),t=a(n);return e.jsxs("div",{className:"flex flex-col border rounded-lg sm:rounded-xl overflow-hidden min-h-[120px] sm:min-h-[150px]",style:{backgroundColor:"var(--color-bg-secondary)",borderColor:v?"var(--color-accent)":"var(--color-border)",borderWidth:v?"2px":"1px"},children:[e.jsxs("div",{className:"p-2 sm:p-3 text-center border-b",style:{backgroundColor:v?"var(--color-accent)":"var(--color-bg-primary)",borderColor:"var(--color-border)"},children:[e.jsx("div",{className:"text-[10px] sm:text-xs font-medium mb-0.5 sm:mb-1 uppercase",style:{color:v?"#FFFFFF":"var(--color-text-secondary)"},children:n.toLocaleDateString("es-ES",{weekday:"short"})}),e.jsx("div",{className:"text-lg sm:text-2xl font-bold",style:{color:v?"#FFFFFF":"var(--color-text-primary)"},children:n.getDate()})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-1 sm:p-2 space-y-1 sm:space-y-2",children:t.length>0?t.map(c=>e.jsx(L,{event:c,compact:!0,onClick:()=>i(c)},c.id)):e.jsx("div",{className:"text-center py-2 sm:py-4 text-[10px] sm:text-xs",style:{color:"var(--color-text-tertiary)"},children:"Sin eventos"})})]},p)})}),u==="list"&&e.jsxs("div",{className:"flex-1 overflow-y-auto space-y-6",children:[h.map((n,p)=>{const v=n.getTime()===g.getTime(),t=a(n);return t.length===0?null:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3 pb-2 border-b",style:{borderColor:"var(--color-border)"},children:[e.jsx("div",{className:`w-12 h-12 rounded-xl flex items-center justify-center font-bold ${v?"text-white":""}`,style:{backgroundColor:v?"var(--color-accent)":"var(--color-bg-secondary)",color:v?"#FFFFFF":"var(--color-text-primary)"},children:n.getDate()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold capitalize",style:{color:"var(--color-text-primary)"},children:n.toLocaleDateString("es-ES",{weekday:"long"})}),e.jsx("div",{className:"text-sm",style:{color:"var(--color-text-secondary)"},children:n.toLocaleDateString("es-ES",{day:"numeric",month:"long"})})]})]}),e.jsx("div",{className:"space-y-2 pl-4",children:t.map(c=>e.jsx(L,{event:c,onClick:()=>i(c)},c.id))})]},p)}),r.length===0&&e.jsxs("div",{className:"text-center py-12 rounded-xl border",style:{backgroundColor:"var(--color-bg-secondary)",borderColor:"var(--color-border)"},children:[e.jsx(R,{size:48,className:"mx-auto mb-3",style:{color:"var(--color-text-tertiary)"}}),e.jsx("p",{style:{color:"var(--color-text-secondary)"},children:"No hay eventos esta semana"})]})]})]})}const te="https://api.al-eon.com";async function A(r){try{const o=await fetch(`${te}/api/notifications/schedule`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)});if(!o.ok){const l=await o.json();throw new Error(l.message||"Error al programar notificaci√≥n")}return await o.json()}catch(o){throw console.error("[NotificationsService] Error en scheduleNotification:",o),o}}const k="ale_calendar_event_draft";function oe({userId:r,accessToken:o,initialDate:l,onClose:i,onEventCreated:d}){const{toast:u}=F(),[y,x]=w.useState(!1),h=P.useRef(null);w.useEffect(()=>{h.current&&(h.current.scrollTop=0)},[]);const g=()=>{try{const s=localStorage.getItem(k);if(s){const n=JSON.parse(s);return l?{...n,startDate:l.toISOString().split("T")[0],endDate:l.toISOString().split("T")[0]}:n}}catch(s){console.error("Error recuperando draft:",s)}return{title:"",startDate:l?l.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],startTime:"09:00",endDate:l?l.toISOString().split("T")[0]:new Date().toISOString().split("T")[0],endTime:"10:00",description:"",location:"",attendees:"",reminder:null}},[a,N]=w.useState(g);w.useEffect(()=>{try{localStorage.setItem(k,JSON.stringify(a))}catch(s){console.error("Error guardando draft:",s)}},[a]);function m(s,n){N(p=>({...p,[s]:n}))}async function b(s){if(s.preventDefault(),!!r)try{if(x(!0),!a.title||!a.title.trim()){u({variant:"destructive",title:"Error",description:"El t√≠tulo del evento es obligatorio"}),x(!1);return}const n=new Date(`${a.startDate}T${a.startTime}`),p=new Date(`${a.endDate}T${a.endTime}`);if(p<=n){u({variant:"destructive",title:"Error",description:"La fecha de fin debe ser posterior a la de inicio"}),x(!1);return}const v=n.toISOString(),t=p.toISOString(),c={userId:r,title:a.title.trim(),from:v,to:t,...a.description&&{description:a.description},...a.location&&{location:a.location},...a.attendees&&{attendees:a.attendees.split(",").map(f=>f.trim()).filter(f=>f)}};console.log("üìÖ [CreateEvent] Enviando al backend:",{...c,hasToken:!!o,tokenLength:o==null?void 0:o.length});const j=await Y(c,o);if(console.log("‚úÖ [CreateEvent] Evento creado exitosamente:",j),a.reminder&&j.eventId)try{const f=parseInt(a.reminder),C=new Date(v);C.setMinutes(C.getMinutes()-f),await A({userId:r,type:"calendar_reminder",title:`Recordatorio: ${a.title}`,message:`Tu evento "${a.title}" comienza en ${f===15?"15 minutos":f===60?"1 hora":"1 d√≠a"}`,scheduledFor:C.toISOString(),channel:"telegram",metadata:{eventId:j.eventId,eventTitle:a.title,eventStartTime:v}})}catch(f){console.warn("‚ö†Ô∏è [CreateEvent] No se pudo crear recordatorio:",f)}u({title:"Evento creado correctamente",description:j.message||(a.reminder?`"${a.title}" se cre√≥ con recordatorio`:`"${a.title}"`)});try{localStorage.removeItem(k)}catch(f){console.error("Error limpiando draft:",f)}i();try{await d()}catch(f){console.warn("‚ö†Ô∏è [CreateEvent] No se pudo recargar lista de eventos:",f)}}catch(n){console.error("‚ùå [CreateEvent] Error al crear evento:",n),u({variant:"destructive",title:"Error al crear evento",description:n.message||"No se pudo crear el evento"})}finally{x(!1)}}return e.jsx("div",{ref:h,className:"fixed inset-0 z-[9999] flex items-center justify-center p-4 overflow-y-auto",style:{backgroundColor:"rgba(0, 0, 0, 0.6)"},onClick:i,children:e.jsxs("div",{className:"w-full max-w-2xl my-8 rounded-2xl shadow-2xl relative z-[10000]",style:{backgroundColor:"var(--color-bg-secondary)"},onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"px-4 py-3 border-b flex items-center justify-between",style:{borderColor:"var(--color-border)",backgroundColor:"var(--color-bg-secondary)"},children:[e.jsx("h2",{className:"text-lg font-semibold",style:{color:"var(--color-text-primary)"},children:"Nuevo evento"}),e.jsx("button",{onClick:i,className:"p-1.5 rounded-lg transition-all hover:opacity-80",style:{color:"var(--color-text-secondary)"},children:e.jsx(_,{size:20})})]}),e.jsxs("form",{onSubmit:b,className:"p-6 space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"T√≠tulo del evento"}),e.jsx("input",{type:"text",value:a.title,onChange:s=>m("title",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},placeholder:"Ej: Reuni√≥n de equipo",required:!0,autoFocus:!0})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Fecha de inicio"}),e.jsx("input",{type:"date",value:a.startDate,onChange:s=>m("startDate",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Hora de inicio"}),e.jsx("input",{type:"time",value:a.startTime,onChange:s=>m("startTime",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Fecha de fin"}),e.jsx("input",{type:"date",value:a.endDate,onChange:s=>m("endDate",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Hora de fin"}),e.jsx("input",{type:"time",value:a.endTime,onChange:s=>m("endTime",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},required:!0})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1.5 flex items-center gap-2",style:{color:"var(--color-text-primary)"},children:[e.jsx(z,{size:14}),"Ubicaci√≥n (opcional)"]}),e.jsx("input",{type:"text",value:a.location,onChange:s=>m("location",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},placeholder:"Ej: Sala de conferencias A"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1.5 flex items-center gap-2",style:{color:"var(--color-text-primary)"},children:[e.jsx($,{size:14}),"Asistentes (opcional)"]}),e.jsx("input",{type:"text",value:a.attendees,onChange:s=>m("attendees",s.target.value),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"},placeholder:"email1@example.com, email2@example.com"}),e.jsx("p",{className:"text-xs mt-1",style:{color:"var(--color-text-tertiary)"},children:"Separa los emails con comas"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Descripci√≥n (opcional)"}),e.jsx("textarea",{value:a.description,onChange:s=>m("description",s.target.value),className:"w-full px-4 py-3 rounded-lg border resize-none",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)",minHeight:"100px"},placeholder:"Detalles adicionales del evento..."})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2 flex items-center gap-2",style:{color:"var(--color-text-primary)"},children:[e.jsx(D,{size:14}),"Recordarme"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[{value:null,label:"Sin recordatorio"},{value:"15",label:"15 minutos antes"},{value:"60",label:"1 hora antes"},{value:"1440",label:"1 d√≠a antes"}].map(s=>e.jsx("button",{type:"button",onClick:()=>m("reminder",s.value),className:`px-3 py-2 text-sm rounded-lg border transition-all ${a.reminder===s.value?"font-semibold":""}`,style:{backgroundColor:a.reminder===s.value?"var(--color-accent)":"var(--color-bg-primary)",borderColor:a.reminder===s.value?"var(--color-accent)":"var(--color-border)",color:a.reminder===s.value?"#FFFFFF":"var(--color-text-primary)"},children:s.label},s.value||"none"))}),a.reminder&&e.jsx("p",{className:"text-xs mt-2",style:{color:"var(--color-text-secondary)"},children:"Recibir√°s una notificaci√≥n por Telegram"})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{type:"submit",disabled:y,className:"flex-1 py-3 px-4 rounded-xl font-medium transition-all hover:opacity-90 disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:"var(--color-accent)",color:"#FFFFFF"},children:[y&&e.jsx(T,{size:18,className:"animate-spin"}),y?"Creando...":"Crear evento"]}),e.jsx("button",{type:"button",onClick:i,disabled:y,className:"px-6 py-3 rounded-xl font-medium border transition-all hover:opacity-90 disabled:opacity-50",style:{borderColor:"var(--color-border)",color:"var(--color-text-secondary)"},children:"Cancelar"})]})]})]})})}function ae({event:r,accessToken:o,onClose:l,onEventUpdated:i,onEventDeleted:d}){const{toast:u}=F(),[y,x]=w.useState(!1),[h,g]=w.useState(!1),a=r.from||r.startTime,N=r.to||r.endTime,[m,b]=w.useState({title:r.title,description:r.description||"",location:r.location||"",reminder:r.notification_minutes?String(r.notification_minutes):null});function s(t){return new Date(t).toLocaleString("es-ES",{weekday:"long",day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}function n(t,c){const j=new Date(t),f=new Date(c),C=Math.floor((f-j)/(1e3*60));if(C<60)return`${C} minutos`;{const S=Math.floor(C/60),I=C%60;return I>0?`${S} hora${S>1?"s":""} ${I} minutos`:`${S} hora${S>1?"s":""}`}}async function p(){if(r.id)try{if(x(!0),await Z(r.id,m,o),m.reminder!==(r.notification_minutes?String(r.notification_minutes):null))try{if(m.reminder){const t=parseInt(m.reminder),c=new Date(a);c.setMinutes(c.getMinutes()-t),await A({userId:r.ownerUserId||r.userId,type:"calendar_reminder",title:`Recordatorio: ${m.title}`,message:`Tu evento "${m.title}" comienza en ${t===15?"15 minutos":t===60?"1 hora":"1 d√≠a"}`,scheduledFor:c.toISOString(),channel:"telegram",metadata:{eventId:r.id,eventTitle:m.title,eventStartTime:a}})}}catch(t){console.warn("‚ö†Ô∏è No se pudo actualizar recordatorio:",t)}u({title:"Evento actualizado",description:"Los cambios se guardaron correctamente"}),g(!1),i()}catch(t){u({variant:"destructive",title:"Error",description:t.message||"No se pudo actualizar el evento"})}finally{x(!1)}}async function v(){if(confirm("¬øEliminar permanentemente este evento?"))try{x(!0),await X(r.id,o),u({title:"Evento eliminado",description:"El evento se elimin√≥ permanentemente"}),d(),l()}catch(t){u({variant:"destructive",title:"Error",description:t.message||"No se pudo eliminar el evento"})}finally{x(!1)}}return e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center p-4 overflow-y-auto",style:{backgroundColor:"rgba(0, 0, 0, 0.6)"},onClick:l,children:e.jsxs("div",{className:"w-full max-w-2xl my-8 rounded-2xl shadow-2xl max-h-[90vh] overflow-y-auto",style:{backgroundColor:"var(--color-bg-secondary)"},onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"px-6 py-4 border-b flex items-center justify-between",style:{borderColor:"var(--color-border)"},children:[e.jsx("h2",{className:"text-xl font-bold",style:{color:"var(--color-text-primary)"},children:"Detalles del evento"}),e.jsx("button",{onClick:l,className:"p-2 rounded-lg transition-all hover:opacity-80",style:{color:"var(--color-text-secondary)"},children:e.jsx(_,{size:20})})]}),e.jsx("div",{className:"p-6 space-y-6",children:h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"T√≠tulo"}),e.jsx("input",{type:"text",value:m.title,onChange:t=>b(c=>({...c,title:t.target.value})),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Ubicaci√≥n"}),e.jsx("input",{type:"text",value:m.location,onChange:t=>b(c=>({...c,location:t.target.value})),className:"w-full px-4 py-2.5 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)"}})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1.5",style:{color:"var(--color-text-primary)"},children:"Descripci√≥n"}),e.jsx("textarea",{value:m.description,onChange:t=>b(c=>({...c,description:t.target.value})),className:"w-full px-4 py-3 rounded-lg border resize-none",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)",color:"var(--color-text-primary)",minHeight:"100px"}})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-2 flex items-center gap-2",style:{color:"var(--color-text-primary)"},children:[e.jsx(D,{size:14}),"Recordarme"]}),e.jsx("div",{className:"grid grid-cols-4 gap-2",children:[{value:null,label:"Sin recordatorio"},{value:"15",label:"15 min antes"},{value:"30",label:"30 min antes"},{value:"60",label:"1 hora antes"}].map(t=>e.jsx("button",{type:"button",onClick:()=>b(c=>({...c,reminder:t.value})),className:`px-3 py-2 text-sm rounded-lg border transition-all ${m.reminder===t.value?"font-semibold":""}`,style:{backgroundColor:m.reminder===t.value?"var(--color-accent)":"var(--color-bg-primary)",borderColor:m.reminder===t.value?"var(--color-accent)":"var(--color-border)",color:m.reminder===t.value?"#FFFFFF":"var(--color-text-primary)"},children:t.label},t.value||"none"))})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{children:e.jsx("h3",{className:"text-2xl font-bold mb-4",style:{color:"var(--color-text-primary)"},children:r.title})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(O,{size:20,style:{color:"var(--color-accent)",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium capitalize",style:{color:"var(--color-text-primary)"},children:s(a)}),e.jsxs("p",{className:"text-sm mt-1",style:{color:"var(--color-text-secondary)"},children:["Hasta: ",s(N)]}),e.jsxs("p",{className:"text-sm mt-1",style:{color:"var(--color-text-tertiary)"},children:["Duraci√≥n: ",n(a,N)]})]})]}),r.notification_minutes&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(D,{size:20,style:{color:"var(--color-accent)",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",style:{color:"var(--color-text-primary)"},children:"Recordatorio"}),e.jsxs("p",{className:"text-sm mt-1",style:{color:"var(--color-text-secondary)"},children:[r.notification_minutes===15&&"15 minutos antes",r.notification_minutes===30&&"30 minutos antes",r.notification_minutes===60&&"1 hora antes",r.notification_minutes===1440&&"1 d√≠a antes",![15,30,60,1440].includes(r.notification_minutes)&&`${r.notification_minutes} minutos antes`]}),e.jsx("p",{className:"text-xs mt-1",style:{color:"var(--color-text-tertiary)"},children:"Recibir√°s notificaci√≥n por Telegram"})]})]}),r.location&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(z,{size:20,style:{color:"var(--color-accent)",marginTop:"2px"}}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium mb-1",style:{color:"var(--color-text-primary)"},children:r.location}),e.jsx("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.location)}`,target:"_blank",rel:"noopener noreferrer",className:"text-sm hover:underline",style:{color:"var(--color-accent)"},children:"Ver en Google Maps ‚Üí"})]})]}),e.jsx("div",{className:"w-full h-64 rounded-lg overflow-hidden border",style:{borderColor:"var(--color-border)"},children:e.jsx("iframe",{width:"100%",height:"100%",frameBorder:"0",style:{border:0},referrerPolicy:"no-referrer-when-downgrade",src:`https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=${encodeURIComponent(r.location)}&zoom=15`,allowFullScreen:!0})})]}),r.attendees&&r.attendees.length>0&&e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx($,{size:20,style:{color:"var(--color-accent)",marginTop:"2px"}}),e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium mb-1",style:{color:"var(--color-text-primary)"},children:[r.attendees.length," asistente(s)"]}),e.jsx("ul",{className:"text-sm space-y-1",style:{color:"var(--color-text-secondary)"},children:r.attendees.map((t,c)=>e.jsx("li",{children:t},c))})]})]})]}),r.description&&e.jsxs("div",{className:"p-4 rounded-lg border",style:{backgroundColor:"var(--color-bg-primary)",borderColor:"var(--color-border)"},children:[e.jsx("h4",{className:"font-semibold mb-2",style:{color:"var(--color-text-primary)"},children:"Descripci√≥n"}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",style:{color:"var(--color-text-secondary)"},children:r.description})]})]})}),e.jsx("div",{className:"px-6 py-4 border-t flex items-center justify-between",style:{borderColor:"var(--color-border)"},children:h?e.jsxs("div",{className:"flex gap-2 w-full",children:[e.jsxs("button",{onClick:p,disabled:y,className:"flex-1 py-2.5 px-4 rounded-xl font-medium transition-all hover:opacity-90 disabled:opacity-50 flex items-center justify-center gap-2",style:{backgroundColor:"var(--color-accent)",color:"#FFFFFF"},children:[y&&e.jsx(T,{size:16,className:"animate-spin"}),"Guardar cambios"]}),e.jsx("button",{onClick:()=>g(!1),disabled:y,className:"px-4 py-2.5 rounded-xl font-medium border transition-all hover:opacity-90",style:{borderColor:"var(--color-border)",color:"var(--color-text-secondary)"},children:"Cancelar"})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex gap-2",children:e.jsxs("button",{onClick:()=>g(!0),className:"px-4 py-2 rounded-lg font-medium border transition-all hover:opacity-80 flex items-center gap-2",style:{borderColor:"var(--color-border)",color:"var(--color-text-primary)"},children:[e.jsx(B,{size:16}),"Editar"]})}),e.jsxs("button",{onClick:v,disabled:y,className:"px-4 py-2 rounded-lg font-medium border transition-all hover:opacity-80 flex items-center gap-2",style:{borderColor:"#ef4444",color:"#ef4444"},children:[y?e.jsx(T,{size:16,className:"animate-spin"}):e.jsx(V,{size:16}),"Eliminar"]})]})})]})})}function he(){const{user:r,accessToken:o,loading:l}=U();F();const i=H(),[d,u]=w.useState([]),[y,x]=w.useState(!0),[h,g]=w.useState(!1),[a,N]=w.useState(new Date),[m,b]=w.useState(null);w.useEffect(()=>{r!=null&&r.id&&s()},[r,a]);async function s(){if(!(r!=null&&r.id)){console.warn("[CalendarPage] No user ID available"),x(!1);return}if(!o){console.warn("[CalendarPage] No access token available"),x(!1);return}try{const t=await ee(r.id,o);u(t||[])}catch(t){console.error("Error cargando eventos:",t)}finally{x(!1)}}if(l)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"var(--color-bg-primary)"},children:e.jsx("div",{style:{color:"var(--color-text-secondary)"},children:"Cargando..."})});if(!r)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",style:{backgroundColor:"var(--color-bg-primary)"},children:e.jsx("div",{style:{color:"var(--color-text-secondary)"},children:"Por favor inicia sesi√≥n"})});function n(){s(),g(!1)}function p(){s()}function v(){s(),b(null)}return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"h-screen flex flex-col overflow-hidden",style:{backgroundColor:"var(--color-bg-primary)"},children:[e.jsxs("div",{className:"border-b px-4 sm:px-6 py-3 sm:py-4 flex flex-col sm:flex-row items-start sm:items-center gap-3 sm:gap-4 justify-between",style:{borderColor:"var(--color-border)"},children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 w-full sm:w-auto",children:[e.jsxs("button",{onClick:()=>i(-1),className:"flex items-center gap-2 px-3 sm:px-4 py-2 rounded-lg transition-all hover:opacity-80 text-sm sm:text-base",style:{backgroundColor:"var(--color-bg-secondary)",color:"var(--color-text-primary)",border:"1px solid var(--color-border)"},children:[e.jsx(J,{size:18}),e.jsx("span",{className:"font-medium",children:"Volver"})]}),e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx(R,{className:"w-5 h-5 sm:w-6 sm:h-6",style:{color:"var(--color-accent)"}}),e.jsx("h1",{className:"text-xl sm:text-2xl font-bold",style:{color:"var(--color-text-primary)"},children:"Agenda"})]})]}),!h&&e.jsxs("button",{onClick:()=>{console.log("üîµ Abriendo modal, bot√≥n debe desaparecer"),g(!0)},className:"py-2 sm:py-2.5 px-4 sm:px-5 rounded-xl font-medium transition-all hover:opacity-90 flex items-center gap-2 text-sm sm:text-base w-full sm:w-auto justify-center",style:{backgroundColor:"var(--color-accent)",color:"#FFFFFF"},children:[e.jsx(G,{className:"w-4 h-4 sm:w-5 sm:h-5"}),e.jsx("span",{className:"hidden sm:inline",children:"Nuevo evento"}),e.jsx("span",{className:"sm:hidden",children:"Nuevo"})]}),h&&e.jsx("div",{className:"py-2 sm:py-2.5 px-4 sm:px-5 text-sm text-green-500",children:"‚úÖ Modal abierto - bot√≥n oculto"})]}),e.jsx("div",{className:"flex-1 overflow-auto p-2 sm:p-4 md:p-6",children:e.jsx(re,{events:d,selectedDate:a,onDateChange:N,onEventClick:t=>{console.log("üìÖ [CalendarPage] Evento clickeado:",t),b(t)},onEventUpdated:p})})]}),h&&e.jsx(oe,{userId:r==null?void 0:r.id,accessToken:o,initialDate:a,onClose:()=>g(!1),onEventCreated:n}),m&&e.jsx(ae,{event:m,accessToken:o,onClose:()=>b(null),onEventUpdated:p,onEventDeleted:v})]})}export{he as default};
