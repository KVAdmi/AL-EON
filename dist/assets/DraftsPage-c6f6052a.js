import{c as B,j as e,X as L,r as n,u as $,e as z}from"./index-e4e1323c.js";import{j as I,k as M,l as R,m as q,n as H,o as G,p as K,g as V,q as W}from"./emailService-c4da49df.js";import{F as X}from"./file-text-dbc5a523.js";import{C as J}from"./clock-8cb9f32e.js";import{T as O}from"./trash-2-720af3a0.js";import{D as Q}from"./download-d08d90ee.js";import{I as U}from"./image-2a707bef.js";import{P as Y}from"./paperclip-ea40dd47.js";import{S as Z}from"./send-1877c269.js";import{A as ee}from"./arrow-left-1a8dd8e5.js";import{P as te}from"./plus-b374ad1c.js";import"./requestId-b38e007e.js";const se=B("File",[["path",{d:"M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z",key:"1nnpy2"}],["polyline",{points:"14 2 14 8 20 8",key:"1ew0cm"}]]);function re({drafts:t,onSelectDraft:l,onDraftDeleted:d}){const m=async(s,c)=>{if(s.stopPropagation(),!!confirm("¿Eliminar este borrador?"))try{await I(c),d==null||d(c)}catch(i){console.error("Error deleting draft:",i),alert("Error al eliminar borrador")}},r=s=>{const c=new Date(s),i=new Date,x=i-c;return x<6e4?"Hace un momento":x<36e5?`Hace ${Math.floor(x/6e4)} min`:c.toDateString()===i.toDateString()?c.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"}):x<6048e5?c.toLocaleDateString("es-ES",{weekday:"short"}):c.toLocaleDateString("es-ES",{month:"short",day:"numeric"})};return t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-gray-500",children:[e.jsx(X,{className:"w-12 h-12 mb-3 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No tienes borradores guardados"})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:t.map(s=>e.jsx("div",{onClick:()=>l(s),className:"p-4 hover:bg-gray-50 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Para:"}),e.jsx("span",{className:"text-sm font-medium text-gray-800 truncate",children:s.to_email||"(sin destinatario)"})]}),e.jsx("div",{className:"text-sm font-semibold text-gray-900 mb-1 truncate",children:s.subject||"(sin asunto)"}),e.jsx("div",{className:"text-sm text-gray-600 line-clamp-2",children:s.body||"(sin contenido)"}),e.jsxs("div",{className:"flex items-center gap-1 mt-2 text-xs text-gray-500",children:[e.jsx(J,{className:"w-3 h-3"}),e.jsx("span",{children:r(s.updated_at)})]})]}),e.jsx("button",{onClick:c=>m(c,s.draft_id),className:"p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0",title:"Eliminar borrador",children:e.jsx(O,{className:"w-4 h-4"})})]})},s.draft_id))})}function ae({attachments:t,onDelete:l}){const d=r=>r.startsWith("image/")?U:se,m=r=>r<1024?`${r} B`:r<1048576?`${(r/1024).toFixed(1)} KB`:`${(r/1048576).toFixed(1)} MB`;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700",children:["Adjuntos (",t.length,")"]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:t.map(r=>{const s=d(r.mime_type),c=M(r.attachment_id);return e.jsxs("div",{className:"flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(s,{className:"w-5 h-5 text-gray-500 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium text-gray-800 truncate",children:r.filename}),e.jsx("div",{className:"text-xs text-gray-500",children:m(r.file_size)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("a",{href:c,download:!0,target:"_blank",rel:"noopener noreferrer",className:"p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"Descargar",children:e.jsx(Q,{className:"w-4 h-4"})}),l&&e.jsx("button",{onClick:()=>l(r.attachment_id),className:"p-2 text-gray-600 hover:text-red-600 hover:bg-red-50 rounded transition-colors",title:"Eliminar",children:e.jsx(L,{className:"w-4 h-4"})})]})]},r.attachment_id)})})]})}function ne({draft:t,accountId:l,ownerUserId:d,onClose:m,onSent:r}){const[s,c]=n.useState((t==null?void 0:t.to_email)||""),[i,x]=n.useState((t==null?void 0:t.subject)||""),[h,w]=n.useState((t==null?void 0:t.body)||""),[p,j]=n.useState((t==null?void 0:t.attachments)||[]),[u,y]=n.useState((t==null?void 0:t.draft_id)||null),[S,g]=n.useState(!1),[f,E]=n.useState(!1),[D,A]=n.useState(null),k=n.useRef(null),o=n.useRef(null);n.useEffect(()=>{if(!(!l||!d))return o.current&&clearTimeout(o.current),o.current=setTimeout(()=>{v()},2e3),()=>{o.current&&clearTimeout(o.current)}},[s,i,h]);const v=async()=>{if(!(!l||!d)&&!(!s&&!i&&!h)){g(!0);try{if(u)await R(u,{to_email:s,subject:i,body:h});else{const a=await q({account_id:l,owner_user_id:d,to_email:s,subject:i,body:h});y(a.draft.draft_id)}A(new Date)}catch(a){console.error("Error autosaving draft:",a)}finally{g(!1)}}},C=async a=>{const N=Array.from(a.target.files);if(!u){alert("Debes escribir algo primero para que se cree el borrador");return}for(const b of N){if(b.size>25*1024*1024){alert(`El archivo ${b.name} es muy grande (máx 25MB)`);continue}try{const _=await H(b,d,u);j(P=>[...P,_.attachment])}catch(_){console.error("Error uploading file:",_),alert(`Error al subir ${b.name}: ${_.message}`)}}},T=async a=>{try{await G(a),j(N=>N.filter(b=>b.attachment_id!==a))}catch(N){console.error("Error deleting attachment:",N),alert("Error al eliminar adjunto")}},F=async()=>{if(!s||!i){alert('Debes llenar "Para" y "Asunto"');return}if(!u){alert("El borrador no se ha guardado aún");return}E(!0);try{await K(u),alert("✅ Email enviado exitosamente"),r==null||r(),m()}catch(a){console.error("Error sending email:",a),alert(`Error al enviar: ${a.message}`)}finally{E(!1)}};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-800",children:t?"Editar Borrador":"Nuevo Email"}),S&&e.jsx("span",{className:"text-xs text-gray-500 animate-pulse",children:"Guardando..."}),D&&!S&&e.jsxs("span",{className:"text-xs text-gray-500",children:["Guardado ",D.toLocaleTimeString()]})]}),e.jsx("button",{onClick:m,className:"text-gray-400 hover:text-gray-600 transition-colors",children:e.jsx(L,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Para:"}),e.jsx("input",{type:"email",value:s,onChange:a=>c(a.target.value),placeholder:"destinatario@ejemplo.com",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Asunto:"}),e.jsx("input",{type:"text",value:i,onChange:a=>x(a.target.value),placeholder:"Escribe el asunto del email",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Mensaje:"}),e.jsx("textarea",{value:h,onChange:a=>w(a.target.value),placeholder:"Escribe tu mensaje aquí...",rows:12,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"})]}),p.length>0&&e.jsx(ae,{attachments:p,onDelete:T})]}),e.jsxs("div",{className:"p-4 border-t border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"file",ref:k,onChange:C,multiple:!0,className:"hidden"}),e.jsxs("button",{onClick:()=>{var a;return(a=k.current)==null?void 0:a.click()},disabled:!u,className:"flex items-center gap-2 px-3 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm",children:"Adjuntar"})]})]}),e.jsxs("button",{onClick:F,disabled:f||!s||!i,className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Z,{className:"w-4 h-4"}),e.jsx("span",{children:f?"Enviando...":"Enviar"})]})]})]})})}function pe(){const t=$(),{user:l,accessToken:d}=z(),[m,r]=n.useState([]),[s,c]=n.useState([]),[i,x]=n.useState(null),[h,w]=n.useState(!0),[p,j]=n.useState(null),[u,y]=n.useState(!1),[S,g]=n.useState(null);n.useEffect(()=>{f()},[l]);const f=async()=>{if(l!=null&&l.id){w(!0),j(null);try{const o=await V(l.id,d);if(c(o),o.length>0){x(o[0]);const v=await W(l.id,o[0].account_id);r(v)}}catch(o){console.error("Error loading drafts:",o),j(o.message)}finally{w(!1)}}},E=o=>{g(o),y(!0)},D=()=>{if(!i){alert("Debes tener al menos una cuenta de email configurada");return}g(null),y(!0)},A=o=>{r(v=>v.filter(C=>C.draft_id!==o))},k=()=>{f()};return h?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 px-6 py-4",children:e.jsxs("div",{className:"max-w-7xl mx-auto flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>t(-1),className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ee,{className:"w-5 h-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Borradores"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[m.length," ",m.length===1?"borrador":"borradores"," guardados"]})]})]}),e.jsxs("button",{onClick:D,disabled:s.length===0,className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(te,{className:"w-5 h-5"}),e.jsx("span",{children:"Nuevo Borrador"})]})]})}),e.jsxs("div",{className:"max-w-4xl mx-auto py-6 px-6",children:[p&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsx("p",{className:"text-sm text-red-800",children:p})}),s.length===0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-8 text-center",children:[e.jsx("p",{className:"text-gray-600 mb-4",children:"No tienes cuentas de email configuradas"}),e.jsx("button",{onClick:()=>t("/email"),className:"text-blue-600 hover:text-blue-700 font-medium",children:"Configurar cuenta de email"})]}):e.jsx("div",{className:"bg-white rounded-lg shadow-sm",children:e.jsx(re,{drafts:m,onSelectDraft:E,onDraftDeleted:A})})]}),u&&i&&e.jsx(ne,{draft:S,accountId:i.account_id||i.id,ownerUserId:l==null?void 0:l.id,onClose:()=>{y(!1),g(null),f()},onSent:k})]})}export{pe as default};
