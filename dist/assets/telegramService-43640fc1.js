import{s as m}from"./index-e4e1323c.js";const d="https://api.al-eon.com";async function g(){const{data:{session:s},error:o}=await m.auth.getSession();if(o)throw console.error("[TelegramService] Error obteniendo sesi√≥n:",o),new Error("Error de autenticaci√≥n");if(!(s!=null&&s.access_token))throw new Error("No hay sesi√≥n activa. Por favor inicia sesi√≥n.");return s.access_token}async function p(s){try{console.log("[TelegramService] üîç Iniciando conexi√≥n de bot..."),console.log("[TelegramService] Datos recibidos:",{...s,botToken:s.botToken?"***HIDDEN***":"NO_TOKEN"});const o=await g();console.log("[TelegramService] ‚úÖ Token JWT obtenido:",o?o.substring(0,20)+"...":"NO_TOKEN"),console.log("[TelegramService] üì§ Enviando request a:",`${d}/api/telegram/bots/connect`);const t=await fetch(`${d}/api/telegram/bots/connect`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify(s)});if(console.log("[TelegramService] üì• Response status:",t.status,t.statusText),!t.ok){let n="";try{n=await t.text(),console.error("[TelegramService] ‚ö†Ô∏è Error response:",n)}catch(e){console.error("[TelegramService] No se pudo leer el texto del error:",e)}if(t.status===409||n.includes("already exists")||n.includes("ya existe")){console.log("[TelegramService] ‚ÑπÔ∏è Bot ya existe, buscando en BD...");try{const{data:e,error:a}=await m.from("telegram_bots").select("*").eq("bot_username",s.botUsername).eq("owner_user_id",s.ownerUserId).single();if(!a&&e)return console.log("[TelegramService] ‚úÖ Bot encontrado en Supabase:",e),{id:e.id,botUsername:e.bot_username,botToken:e.bot_token_enc,ownerUserId:e.owner_user_id,isConnected:!0,webhook:e.webhook_url,createdAt:e.created_at}}catch(e){console.error("[TelegramService] Error consultando Supabase:",e)}}try{const e=await fetch(`${d}/api/telegram/bots?userId=${s.ownerUserId}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include"});if(e.ok){const a=await e.json();if(Array.isArray(a)){const l=a.find(i=>i.bot_username===s.botUsername||i.botUsername===s.botUsername);if(l)return console.log("[TelegramService] ‚úÖ Bot encontrado via endpoint:",l),l}}}catch(e){console.error("[TelegramService] No se pudo verificar via endpoint:",e)}let r;try{r=JSON.parse(n)}catch{r={message:n.includes("<!DOCTYPE")?"Error del servidor (HTML response)":n}}throw new Error(r.message||"Error al conectar bot de Telegram")}let c;try{return c=await t.json(),console.log("[TelegramService] ‚úÖ Bot conectado exitosamente:",c),c}catch(n){console.error("[TelegramService] Error parseando JSON de respuesta exitosa:",n);const{data:r,error:e}=await m.from("telegram_bots").select("*").eq("bot_username",s.botUsername).eq("owner_user_id",s.ownerUserId).single();if(!e&&r)return console.log("[TelegramService] ‚úÖ Bot recuperado desde Supabase despu√©s de error de parsing:",r),{id:r.id,botUsername:r.bot_username,botToken:r.bot_token_enc,ownerUserId:r.owner_user_id,isConnected:!0,webhook:r.webhook_url,createdAt:r.created_at};throw new Error("Bot conectado pero no se pudo obtener la informaci√≥n")}}catch(o){throw console.error("[TelegramService] ‚ùå Error en connectBot:",o),o}}async function h(s){try{console.log("[TelegramService] üîç Obteniendo bots del usuario...");const o=await g();try{const r=await fetch(`${d}/api/telegram/bots`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include"});if(r.ok){const e=await r.json();if(console.log("[TelegramService] ‚úÖ Bots obtenidos desde backend:",e),Array.isArray(e))return e;if(e&&typeof e=="object"&&Object.keys(e).length>0)return[e];console.warn("[TelegramService] ‚ö†Ô∏è Backend devolvi√≥ formato inv√°lido o vac√≠o, usando Supabase")}}catch(r){console.warn("[TelegramService] ‚ö†Ô∏è Backend no disponible, usando Supabase directamente:",r.message)}const{data:t,error:c}=await m.from("telegram_bots").select("*").eq("owner_user_id",s).order("created_at",{ascending:!1});if(c)throw console.error("[TelegramService] ‚ùå Error en Supabase:",c),new Error(c.message||"Error al obtener bots");return console.log("[TelegramService] ‚úÖ Bots obtenidos desde Supabase:",t),t.map(r=>({id:r.id,botUsername:r.bot_username,botToken:r.bot_token_enc,ownerUserId:r.owner_user_id,isConnected:!0,webhook:r.webhook_url,createdAt:r.created_at}))}catch(o){throw console.error("[TelegramService] Error en getUserBots:",o),o}}async function w(s,o){try{if(!s)throw console.error("[TelegramService] ‚ùå Error: botId es undefined en updateBotSettings"),new Error("ID de bot no v√°lido");const t=await g(),c=`${d}/api/telegram/bots/${s}/settings`;console.log("[TelegramService] üì§ Actualizando configuraci√≥n en:",c);const n=await fetch(c,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include",body:JSON.stringify(o)}),r=await n.text();let e;try{e=JSON.parse(r)}catch{throw console.error("[TelegramService] ‚ùå Error parseando respuesta del servidor:",r),new Error(`Error del servidor (${n.status}): La respuesta no es un JSON v√°lido.`)}if(!n.ok)throw new Error(e.message||e.error||`Error ${n.status} al actualizar configuraci√≥n`);return e}catch(t){throw console.error("[TelegramService] Error en updateBotSettings:",t),t}}async function T(s,o=null){try{console.log("[TelegramService] üîç Obteniendo chats para botId:",o);const t=await g();try{const a=new URLSearchParams;o&&a.append("botId",o);const l=await fetch(`${d}/api/telegram/chats?${a}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include"});if(l.ok){const i=await l.json();return console.log("[TelegramService] ‚úÖ Chats obtenidos desde backend:",i),i}}catch(a){console.warn("[TelegramService] ‚ö†Ô∏è Backend no disponible, usando Supabase directamente:",a.message)}let c=m.from("telegram_chats").select("*").eq("owner_user_id",s).order("last_message_at",{ascending:!1});o&&(c=c.eq("bot_id",o));const{data:n,error:r}=await c;if(r)throw console.error("[TelegramService] ‚ùå Error en Supabase:",r),new Error(r.message||"Error al obtener chats");return console.log("[TelegramService] ‚úÖ Chats obtenidos desde Supabase:",n),n.map(a=>({id:a.id,chatId:a.chat_id,name:a.chat_name,username:a.chat_username,lastMessage:a.last_message_text,lastMessageDate:a.last_message_at,botId:a.bot_id,ownerUserId:a.owner_user_id}))}catch(t){throw console.error("[TelegramService] Error en getChats:",t),t}}async function b(s,o={}){try{console.log("[TelegramService] üì¨ getMessages - chatId:",s,"options:",o);const t=await g();console.log("[TelegramService] Token obtenido:",t?"‚úÖ":"‚ùå");const c=new URLSearchParams({chatId:s,...o}),n=`${d}/api/telegram/messages?${c}`;console.log("[TelegramService] Fetching:",n);const r=await fetch(n,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},credentials:"include"});if(console.log("[TelegramService] Response status:",r.status),!r.ok){const a=await r.text();console.error("[TelegramService] Error response:",a);let l="No se pudieron cargar los mensajes de Telegram.";try{const i=JSON.parse(a);l=(i==null?void 0:i.safe_message)||(i==null?void 0:i.message)||(i==null?void 0:i.error)||l}catch{a&&a.length<200&&(l=a)}throw new Error(l)}const e=await r.json();return console.log("[TelegramService] ‚úÖ Mensajes recibidos:",(e==null?void 0:e.length)||0,"mensajes"),console.log("[TelegramService] Primer mensaje:",e==null?void 0:e[0]),e}catch(t){throw console.error("[TelegramService] ‚ùå Error en getMessages:",t),t}}async function S(s){try{const o=await g(),t=await fetch(`${d}/api/telegram/send`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},credentials:"include",body:JSON.stringify(s)});if(!t.ok){const c=await t.json();throw new Error(c.message||"Error al enviar mensaje")}return await t.json()}catch(o){throw console.error("[TelegramService] Error en sendMessage:",o),o}}export{b as a,T as b,p as c,h as g,S as s,w as u};
