import{s as d}from"./index-e4e1323c.js";const a="https://api.al-eon.com";async function f(){const{data:{session:o}}=await d.auth.getSession();return(o==null?void 0:o.access_token)||null}async function l(o=!0){const t={Authorization:`Bearer ${await f()}`};return o&&(t["Content-Type"]="application/json"),t}async function E(o){try{const{data:e,error:t}=await d.from("meetings").select("*").eq("id",o).single();if(t)throw t;return e}catch(e){throw console.error("[MeetingsService] Error obteniendo reuni√≥n:",e),e}}async function M(o){var e;try{console.log("[MeetingsService] Iniciando reuni√≥n live...");const{data:{session:t}}=await d.auth.getSession();if(!((e=t==null?void 0:t.user)!=null&&e.id))throw new Error("No hay sesi√≥n activa");console.log("[MeetingsService] Usuario autenticado:",t.user.id),console.log("[MeetingsService] Backend URL:",a);const r=new Date().toISOString(),n={title:o||`Reuni√≥n en vivo ${new Date().toLocaleTimeString("es-ES")}`,mode:"live",auto_send_enabled:!1,send_email:!1,send_telegram:!1,participants:[],happened_at:r,scheduled_at:r};console.log("[MeetingsService] Enviando payload:",n);const i=await fetch(`${a}/api/meetings/live/start`,{method:"POST",headers:await l(),body:JSON.stringify(n)});if(console.log("[MeetingsService] Response status:",i.status),!i.ok){let g="No se pudo iniciar la reuni√≥n. Intenta de nuevo.";try{const s=await i.json();console.error("[MeetingsService] Error response:",s),s!=null&&s.safe_message?g=s.safe_message:(s!=null&&s.error||s!=null&&s.message)&&(g=s.error||s.message)}catch{const h=await i.text();console.error("[MeetingsService] Error response (text):",h)}throw new Error(g)}const u=await i.json();console.log("[MeetingsService] ‚úÖ Reuni√≥n creada:",u);const{meetingId:c}=u,{data:w}=await d.from("meetings").select("*").eq("id",c).single();return console.log("[MeetingsService] ‚úÖ Reuni√≥n sincronizada en DB local"),{id:c,...w}}catch(t){throw console.error("[MeetingsService] ‚ùå Error iniciando reuni√≥n live:",t),t}}async function $(o,e,t,r){try{console.log(`[MeetingsService] üì§ Subiendo chunk ${t}:`,{meetingId:o,blobSize:e.size,blobType:e.type,startedAtMs:r});const n=new FormData;n.append("chunk",e,`chunk-${t}-${Date.now()}.webm`),n.append("chunkIndex",t.toString()),r&&n.append("startedAt",r.toString());const i=await l(!1),u=`${a}/api/meetings/live/${o}/chunk`;console.log(`[MeetingsService] üì° POST ${u}`);const c=await fetch(u,{method:"POST",headers:i,body:n});if(console.log(`[MeetingsService] Response status: ${c.status}`),!c.ok){let g="No se pudo procesar el audio de la reuni√≥n.";try{const s=await c.json();console.error("[MeetingsService] ‚ùå Error data:",s),g=(s==null?void 0:s.safe_message)||(s==null?void 0:s.error)||(s==null?void 0:s.message)||g}catch{const h=await c.text();console.error("[MeetingsService] ‚ùå Error text:",h)}throw new Error(g)}const w=await c.json();return console.log(`[MeetingsService] ‚úÖ Chunk ${t} enviado correctamente`),w}catch(n){throw console.error(`[MeetingsService] Error enviando chunk ${t}:`,n),n}}async function x(o){try{const e=await fetch(`${a}/api/meetings/live/${o}/stop`,{method:"POST",headers:await l()});if(!e.ok){let r="No se pudo finalizar la reuni√≥n. Intenta de nuevo.";try{const n=await e.json();r=(n==null?void 0:n.safe_message)||(n==null?void 0:n.error)||(n==null?void 0:n.message)||r}catch{const i=await e.text();console.error("[MeetingsService] Error response (text):",i)}throw new Error(r)}const t=await e.json();return console.log("[MeetingsService] Reuni√≥n finalizada correctamente"),t}catch(e){throw console.error("[MeetingsService] Error finalizando reuni√≥n:",e),e}}async function b(o){try{const e=await fetch(`${a}/api/meetings/live/${o}/status`,{headers:await l()});if(!e.ok){let t="No se pudo obtener el estado de la reuni√≥n.";try{const r=await e.json();t=(r==null?void 0:r.safe_message)||(r==null?void 0:r.error)||(r==null?void 0:r.message)||t}catch{const n=await e.text();console.error("[MeetingsService] Error response (text):",n)}throw new Error(t)}return await e.json()}catch(e){throw console.error("[MeetingsService] Error obteniendo estado:",e),e}}async function k(o){try{const e=await fetch(`${a}/api/meetings/${o}/result`,{headers:await l()});if(!e.ok){let t=`Error ${e.status} obteniendo resultado`;try{const r=await e.json();t=(r==null?void 0:r.error)||(r==null?void 0:r.message)||t}catch{t=await e.text()||t}throw new Error(t)}return await e.json()}catch(e){throw console.error("[MeetingsService] Error obteniendo resultado:",e),e}}async function m(o,e={}){try{const t=await fetch(`${a}/api/meetings/${o}/send`,{method:"POST",headers:await l(),body:JSON.stringify({email:e.email!==!1,telegram:e.telegram||!1,recipients:e.recipients||[]})});if(!t.ok){let r=`Error ${t.status} enviando minuta`;try{const n=await t.json();r=(n==null?void 0:n.error)||(n==null?void 0:n.message)||r}catch{r=await t.text()||r}throw new Error(r)}return await t.json()}catch(t){throw console.error("[MeetingsService] Error enviando minuta:",t),t}}async function p(o,e){return m(o,{email:!0,recipients:e})}async function v(o){try{const e=await fetch(`${a}/api/meetings/${o}/send`,{method:"POST",headers:await l(),body:JSON.stringify({telegram:!0})});if(!e.ok)throw new Error("Error al enviar por Telegram");return await e.json()}catch(e){throw console.error("[MeetingsService] Error enviando por Telegram:",e),e}}async function j(o,e){if(e==="email")return await p(o,[]);if(e==="telegram")return await v(o);throw new Error(`Canal desconocido: ${e}`)}async function S(o,e={}){try{const t=await fetch(`${a}/api/meetings/${o}/calendar`,{method:"POST",headers:await l(),body:JSON.stringify(e)});if(!t.ok){let r=`Error ${t.status} creando eventos de calendario`;try{const n=await t.json();r=(n==null?void 0:n.error)||(n==null?void 0:n.message)||r}catch{r=await t.text()||r}throw new Error(r)}return await t.json()}catch(t){throw console.error("[MeetingsService] Error creando eventos:",t),t}}async function T(o){return S(o)}export{x as a,m as b,k as c,E as d,j as e,T as f,b as g,M as s,$ as u};
